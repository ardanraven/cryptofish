<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoFish Tycoon - Mercado Vol√°til</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); } 50% { box-shadow: 0 0 25px rgba(59, 130, 246, 0.8); } }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }

        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .ticker-wrap { overflow: hidden; white-space: nowrap; }
        .ticker-move { display: inline-block; animation: ticker 40s linear infinite; }

        .fish-card:hover { transform: translateY(-5px); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .loader { border: 4px solid rgba(255, 255, 255, 0.1); border-left-color: #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @keyframes money-up { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }
        .money-popup { position: absolute; color: #4ade80; font-weight: bold; font-size: 0.9rem; animation: money-up 1.5s forwards; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen selection:bg-blue-500 selection:text-white pb-24">

    <!-- MARKET TICKER -->
    <div id="market-ticker-bg" class="w-full h-8 bg-slate-900 border-b border-slate-800 flex items-center overflow-hidden fixed top-0 z-50 shadow-lg">
        <div class="ticker-wrap w-full">
            <div class="ticker-move text-xs font-mono font-bold flex gap-8 items-center text-slate-300" id="market-ticker-content">
                Carregando dados da blockchain...
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[60] flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1639322537228-f710d846310a?auto=format&fit=crop&q=80')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>
        <div class="relative bg-slate-900/90 border border-slate-700 p-8 rounded-2xl shadow-2xl w-full max-w-md m-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-black bg-gradient-to-r from-cyan-400 to-blue-600 bg-clip-text text-transparent mb-2">CRYPTO FISH</h1>
                <p class="text-slate-400 text-xs uppercase tracking-widest">Exchange Descentralizada</p>
            </div>
            <div class="flex bg-slate-800 rounded-lg p-1 mb-6">
                <button onclick="toggleAuthMode('login')" id="btn-mode-login" class="flex-1 py-2 rounded font-bold text-sm bg-blue-600 text-white transition-all">Entrar</button>
                <button onclick="toggleAuthMode('signup')" id="btn-mode-signup" class="flex-1 py-2 rounded font-bold text-sm text-slate-400 hover:text-white transition-all">Criar</button>
            </div>
            <form id="auth-form" onsubmit="handleAuth(event)" class="space-y-4">
                <div id="field-username" class="hidden">
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-1">Trader ID (Nome)</label>
                    <input type="text" id="input-username" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white" placeholder="Whale_01">
                </div>
                <div>
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-1">Email</label>
                    <input type="email" id="input-email" required class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white" placeholder="trader@crypto.com">
                </div>
                <div>
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-1">Senha</label>
                    <input type="password" id="input-password" required minlength="6" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white" placeholder="******">
                </div>
                <div id="auth-error" class="text-red-400 text-xs text-center hidden p-2 bg-red-900/20 rounded border border-red-900/50"></div>
                <button type="submit" id="btn-auth-submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition-all">Conectar √† Rede</button>
            </form>
        </div>
    </div>

    <!-- GAME UI -->
    <div id="game-ui" class="hidden max-w-4xl mx-auto pt-10">
        
        <!-- HEADER -->
        <header class="sticky top-8 z-40 bg-slate-900/95 backdrop-blur border-b border-slate-800 p-4 shadow-xl mb-6 rounded-b-2xl mx-2">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div id="user-avatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold text-lg border-2 border-slate-800 shadow-xl">U</div>
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Patrim√¥nio L√≠quido</div>
                        <div class="font-mono text-xl text-green-400 font-bold flex items-center gap-1 drop-shadow-sm relative">
                            <i data-lucide="coins" class="w-4 h-4"></i> $<span id="user-balance">0</span>
                            <div id="income-popups" class="absolute top-0 right-0 w-full h-full pointer-events-none"></div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Renda (APY)</div>
                    <div class="font-mono text-base text-yellow-400 font-bold flex items-center gap-1 transition-all" id="income-container">
                        <i data-lucide="trending-up" class="w-4 h-4"></i> +$<span id="user-income">0.00</span>/s
                    </div>
                </div>
                <button onclick="handleLogout()" class="ml-4 p-2 bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors" title="Desconectar"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
            
            <!-- ECONOMIC STATUS BAR -->
            <div class="mt-3 flex gap-2 text-[10px] font-mono border-t border-slate-800 pt-2 overflow-x-auto">
                <div id="market-status" class="flex-1 min-w-[100px] bg-slate-800 rounded px-2 py-1 flex justify-between items-center text-gray-300">
                    <span>MERCADO</span> <span class="font-bold">---</span>
                </div>
                <div id="gas-fee" class="flex-1 min-w-[100px] bg-slate-800 rounded px-2 py-1 flex justify-between items-center text-gray-300">
                    <span>GAS</span> <span class="font-bold">$20</span>
                </div>
                <div id="hype-tag" class="flex-1 min-w-[100px] bg-purple-900/50 rounded px-2 py-1 flex justify-between items-center text-purple-300 border border-purple-500/30">
                    <span>HYPE</span> <span class="font-bold">---</span>
                </div>
            </div>
        </header>

        <!-- TABS -->
        <div class="px-4 mb-6 flex gap-2 overflow-x-auto scrollbar-hide">
            <button onclick="switchTab('fishing')" id="tab-fishing" class="tab-btn flex-1 min-w-[100px] bg-blue-600 text-white p-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-900/20 transform scale-105 border border-blue-500 transition-all"><i data-lucide="anchor" class="w-4 h-4"></i> Minerar</button>
            <button onclick="switchTab('inventory')" id="tab-inventory" class="tab-btn flex-1 min-w-[100px] bg-slate-800 text-slate-400 p-3 rounded-xl font-bold flex items-center justify-center gap-2 border border-transparent transition-all"><i data-lucide="wallet" class="w-4 h-4"></i> Wallet</button>
            <button onclick="switchTab('market')" id="tab-market" class="tab-btn flex-1 min-w-[100px] bg-slate-800 text-slate-400 p-3 rounded-xl font-bold flex items-center justify-center gap-2 border border-transparent transition-all"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> Exchange</button>
            <button onclick="switchTab('ranking')" id="tab-ranking" class="tab-btn flex-1 min-w-[100px] bg-slate-800 text-slate-400 p-3 rounded-xl font-bold flex items-center justify-center gap-2 border border-transparent transition-all"><i data-lucide="trophy" class="w-4 h-4"></i> Ranking</button>
        </div>

        <main class="px-4 pb-20">
            <!-- FISHING -->
            <section id="view-fishing" class="animate-float">
                <div id="fishing-bg" class="relative bg-slate-900 border border-slate-800 rounded-2xl h-80 flex flex-col items-center justify-center overflow-hidden shadow-2xl p-6 transition-colors duration-1000">
                    <div class="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-blue-500 to-transparent"></div>
                    
                    <div id="fishing-idle" class="relative z-10 text-center w-full max-w-xs">
                        <div class="text-6xl mb-4 animate-bounce">‚öì</div>
                        <h2 class="text-xl font-bold text-white mb-1">Minera√ß√£o Oce√¢nica</h2>
                        <p class="text-xs text-slate-400 mb-6">Explore blocos de √°gua profunda para encontrar ativos raros.</p>
                        
                        <div class="bg-black/40 p-3 rounded-lg mb-4 border border-slate-700 flex justify-between items-center backdrop-blur-sm">
                            <span class="text-xs text-slate-400">Gas Fee (Custo):</span>
                            <span id="current-fish-cost" class="text-red-400 font-mono font-bold">-$20</span>
                        </div>

                        <button onclick="startFishing()" id="btn-fish" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-500/20 transition-all active:scale-95 border-t border-blue-400">
                            INICIAR MINERA√á√ÉO
                        </button>
                    </div>

                    <div id="fishing-loading" class="hidden relative z-10 text-center">
                        <div class="loader mx-auto mb-4 w-16 h-16 border-4"></div>
                        <p class="text-blue-300 font-mono animate-pulse text-sm">Validando Hash do Bloco...</p>
                        <p class="text-[10px] text-slate-500 mt-2">Isso pode levar alguns segundos.</p>
                    </div>

                    <div id="fishing-result" class="hidden relative z-10 text-center w-full max-w-sm animate-float">
                        <div class="text-7xl mb-2 filter drop-shadow-lg transition-transform hover:scale-110" id="caught-emoji">üêü</div>
                        <h2 id="caught-name" class="text-xl font-black text-white mb-1 truncate">Nome</h2>
                        <div class="text-[10px] font-mono text-slate-400 mb-4 break-all bg-black/40 p-1.5 rounded border border-slate-700" id="caught-hash">Hash: 0x...</div>
                        
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <div class="bg-slate-800/80 p-2 rounded border border-slate-700">
                                <div class="text-[8px] uppercase text-slate-500 font-bold">Peso (Yield)</div>
                                <div id="caught-weight" class="text-yellow-400 font-mono font-bold text-lg">0kg</div>
                            </div>
                            <div class="bg-slate-800/80 p-2 rounded border border-slate-700">
                                <div class="text-[8px] uppercase text-slate-500 font-bold">Valor Atual</div>
                                <div id="caught-val" class="text-green-400 font-mono font-bold text-lg">$0</div>
                            </div>
                        </div>
                        <button onclick="resetFishing()" class="bg-slate-700 hover:bg-slate-600 text-white py-3 px-6 rounded-lg font-bold w-full border border-slate-600">Continuar</button>
                    </div>
                </div>
            </section>

            <!-- INVENTORY -->
            <section id="view-inventory" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2 text-slate-200"><i data-lucide="wallet"></i> Seus Ativos</h2>
                    <span class="text-xs font-mono bg-slate-800 px-3 py-1 rounded-full text-slate-400 border border-slate-700">Total: <span id="inventory-count" class="text-white font-bold">0</span></span>
                </div>
                <div id="inventory-grid" class="grid grid-cols-1 gap-3 pb-10">
                    <!-- Cards will be populated dynamically -->
                </div>
                <div id="inventory-empty" class="hidden text-center py-20 text-slate-500 border-2 border-dashed border-slate-800 rounded-xl bg-slate-900/50">
                    <i data-lucide="ghost" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                    <p>Carteira Vazia.</p>
                    <button onclick="switchTab('fishing')" class="text-blue-400 text-sm mt-2 hover:underline">Come√ßar a minerar</button>
                </div>
            </section>

            <!-- MARKET -->
            <section id="view-market" class="hidden">
                <div class="bg-gradient-to-r from-slate-900 to-slate-800 border border-slate-700 p-6 rounded-xl mb-6 text-center shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-1">Exchange P2P</h2>
                    <p class="text-slate-400 text-xs">Compre e venda ativos com outros traders em tempo real.</p>
                </div>
                <div id="market-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3 pb-10"></div>
                <div id="market-empty" class="hidden text-center py-20 text-slate-500 bg-slate-900/50 rounded-xl border border-slate-800">
                    <i data-lucide="store" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                    <p>O livro de ofertas est√° vazio.</p>
                </div>
            </section>

            <!-- RANKING -->
            <section id="view-ranking" class="hidden">
                <div class="bg-gradient-to-r from-yellow-900/40 to-amber-900/40 border border-yellow-700/30 p-6 rounded-xl mb-6 text-center shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <h2 class="text-xl font-bold text-yellow-100 flex items-center justify-center gap-2"><i data-lucide="crown"></i> Top Whales</h2>
                        <div id="ranking-timer" class="mt-2 text-[10px] font-mono text-yellow-400/70 bg-black/30 inline-block px-2 py-1 rounded">Sincronizando...</div>
                    </div>
                </div>
                <div id="ranking-list" class="space-y-2 pb-10"></div>
            </section>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 opacity-0 transition-opacity duration-300">
        <div id="modal-content" class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-sm shadow-2xl shadow-blue-900/20 transform scale-95 transition-transform duration-300 overflow-hidden">
            <!-- Content -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, increment, runTransaction, collection, addDoc, deleteDoc, query, orderBy, limit, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCAIQdjGBzPWulP2KQcHHmI2r3FgpTfsfg",
            authDomain: "portalarcano-9a0fa.firebaseapp.com",
            projectId: "portalarcano-9a0fa",
            storageBucket: "portalarcano-9a0fa.firebasestorage.app",
            messagingSenderId: "139414169635",
            appId: "1:139414169635:web:31e3a9669c6c08566a2996"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userData = { balance: 0, inventory: [], incomeRate: 0 };
        let accumulatedIncome = 0; 
        let activeTab = 'fishing';
        window.itemsCache = {}; // Cache global acess√≠vel
        
        // ECONOMY STATE
        let marketState = {
            trend: 'NEUTRAL',
            multiplier: 1.0,
            inflation: 1.0,
            hypeTag: 'Alpha' // Default start
        };

        const BASE_BAIT_COST = 20;
        
        // --- DATA ---
        const NAME_PARTS = {
            PREFIX: ["Alpha", "Beta", "Gamma", "Omega", "Neon", "Cyber", "Quantum", "Void", "Solar", "Lunar", "Meta", "Crypto", "Hash", "Block", "Chain", "Ether", "Satoshi", "Bull", "Bear", "Prime", "Giga", "Tera", "Nano", "Pico"],
            SUFFIX: ["Drifter", "Miner", "Validator", "Node", "Token", "Asset", "Ledger", "Whale", "Shark", "Orca", "Kraken", "Oracle", "Protocol", "Contract", "Fork", "DAO", "Yield", "Swap", "Pool", "Hash"]
        };
        
        const EMOJIS = ['üê°', 'üê†', 'üêü', 'ü¶à', 'üê≥', 'üêã', 'üê¨', 'ü¶ë', 'üêô', 'ü¶û', 'ü¶Ä', 'ü¶ê', 'üêö', 'üêå', 'ü¶ï', 'üêä'];

        // --- ECONOMY ENGINE ---
        updateEconomy(); // Run immediately
        setInterval(updateEconomy, 1000);

        function updateEconomy() {
            const now = Date.now();
            const cycleDuration = 300000; // 5 min cycle
            const phase = (now % cycleDuration) / cycleDuration;
            
            const hypeIndex = Math.floor(now / cycleDuration) % NAME_PARTS.PREFIX.length;
            marketState.hypeTag = NAME_PARTS.PREFIX[hypeIndex];

            let rawTrend = Math.sin(phase * Math.PI * 2);
            
            if (rawTrend > 0.2) {
                marketState.trend = 'BULL';
                marketState.multiplier = 1.0 + (rawTrend * 0.5);
                marketState.inflation = 1.0 + (rawTrend * 0.8);
            } else if (rawTrend < -0.2) {
                marketState.trend = 'BEAR';
                marketState.multiplier = 1.0 + (rawTrend * 0.4);
                marketState.inflation = 1.0 + (rawTrend * 0.3);
            } else {
                marketState.trend = 'NEUTRAL';
                marketState.multiplier = 1.0;
                marketState.inflation = 1.0;
            }

            updateUIEconomy();
            if (activeTab === 'inventory') renderInventory(); 
        }

        // --- MATH FUNCTIONS (SAFE) ---
        function getCurrentFishValue(fish) {
            // Safety Check
            const weight = parseFloat(fish.weight) || 1;
            
            let val = weight * 2 * marketState.multiplier;
            
            // Volatility Deterministic Noise
            const idInt = fish.id ? parseInt(fish.id.slice(-4), 16) : 0;
            const timeBlock = Math.floor(Date.now() / 5000);
            const noise = (idInt + timeBlock) % 20 - 10;
            
            val = val + noise;
            return Math.max(1, Math.floor(val));
        }

        function getCurrentIncome(fish) {
            const weight = parseFloat(fish.weight) || 1;
            let income = weight * 0.1;
            
            if (fish.name && fish.name.includes(marketState.hypeTag)) {
                income *= 2;
            }
            if (marketState.trend === 'BEAR') income *= 0.8;
            if (marketState.trend === 'BULL') income *= 1.2;
            
            return Math.max(0.1, parseFloat(income.toFixed(2))); // Min income 0.1
        }

        function updateUIEconomy() {
            const statusEl = document.getElementById('market-status');
            const gasEl = document.getElementById('gas-fee');
            const hypeEl = document.getElementById('hype-tag');
            const tickerEl = document.getElementById('market-ticker-content');
            const fishCostEl = document.getElementById('current-fish-cost');
            const bgEl = document.getElementById('fishing-bg');

            const currentCost = Math.floor(BASE_BAIT_COST * marketState.inflation);
            if (fishCostEl) fishCostEl.textContent = `-$${currentCost}`;

            // Ticker
            let trendIcon = marketState.trend === 'BULL' ? 'üöÄ' : (marketState.trend === 'BEAR' ? 'üîª' : '‚û°Ô∏è');
            let trendColor = marketState.trend === 'BULL' ? 'text-green-400' : (marketState.trend === 'BEAR' ? 'text-red-400' : 'text-slate-400');
            
            tickerEl.innerHTML = `
                <span class="${trendColor}">MARKET: ${marketState.trend} ${trendIcon}</span>
                <span>FISHCOIN: $${(marketState.multiplier * 100).toFixed(2)}</span>
                <span class="text-purple-400">HYPE: ${marketState.hypeTag} üî•</span>
                <span class="text-yellow-400">GAS: $${currentCost} ‚õΩ</span>
                <span>INFLATION: ${((marketState.inflation - 1) * 100).toFixed(0)}%</span>
            `;

            statusEl.innerHTML = `<span class="text-[9px] text-slate-500 mr-2">MERCADO</span> <span class="${trendColor} font-bold">${marketState.trend}</span>`;
            gasEl.innerHTML = `<span class="text-[9px] text-slate-500 mr-2">GAS</span> <span class="text-yellow-400 font-bold">$${currentCost}</span>`;
            hypeEl.innerHTML = `<span class="text-[9px] text-purple-400 mr-2">HYPE</span> <span class="text-white font-bold animate-pulse">${marketState.hypeTag}</span>`;

            if (bgEl) {
                const bgClass = marketState.trend === 'BULL' ? 'bg-emerald-950/30' : (marketState.trend === 'BEAR' ? 'bg-red-950/30' : 'bg-slate-900');
                if (!bgEl.className.includes(bgClass)) { // Avoid constant DOM refresh
                     bgEl.className = `relative border border-slate-800 rounded-2xl h-80 flex flex-col items-center justify-center overflow-hidden shadow-2xl p-6 transition-all duration-1000 ${bgClass}`;
                }
            }
        }

        // --- AUTH & DATA SYNC ---
        window.toggleAuthMode = (mode) => {
            const isLogin = mode === 'login';
            document.getElementById('field-username').style.display = isLogin ? 'none' : 'block';
            document.getElementById('btn-mode-login').className = isLogin ? 'flex-1 py-2 rounded font-bold text-sm bg-blue-600 text-white' : 'flex-1 py-2 rounded font-bold text-sm text-slate-400';
            document.getElementById('btn-mode-signup').className = !isLogin ? 'flex-1 py-2 rounded font-bold text-sm bg-blue-600 text-white' : 'flex-1 py-2 rounded font-bold text-sm text-slate-400';
            document.getElementById('btn-auth-submit').textContent = isLogin ? 'Conectar' : 'Criar Carteira';
            document.getElementById('auth-form').dataset.mode = mode;
        }

        window.handleAuth = async (e) => {
            e.preventDefault();
            const mode = e.target.dataset.mode || 'login';
            const email = document.getElementById('input-email').value;
            const password = document.getElementById('input-password').value;
            const btn = document.getElementById('btn-auth-submit');
            const errDiv = document.getElementById('auth-error');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="loader mx-auto"></div>';
            errDiv.classList.add('hidden');

            try {
                if (mode === 'signup') {
                    const username = document.getElementById('input-username').value;
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(cred.user, { displayName: username });
                    await setDoc(doc(db, 'users', cred.user.uid), {
                        username, balance: 100, inventory: [], createdAt: serverTimestamp()
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (e) {
                errDiv.textContent = e.message;
                errDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'Tentar Novamente';
            }
        };

        window.handleLogout = async () => {
            if (currentUser && accumulatedIncome > 0) {
                await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(accumulatedIncome) });
            }
            signOut(auth);
        };

        onAuthStateChanged(auth, async (user) => {
            const login = document.getElementById('login-screen');
            const ui = document.getElementById('game-ui');
            
            if (user) {
                currentUser = user;
                login.style.display = 'none';
                ui.classList.remove('hidden');
                document.getElementById('user-avatar').textContent = (user.displayName||'U')[0].toUpperCase();
                
                onSnapshot(doc(db, 'users', user.uid), (s) => {
                    if (s.exists()) {
                        const d = s.data();
                        let safeInventory = d.inventory || [];
                        
                        // --- AUTO-CURA (DATA MIGRATION) ---
                        // Se peixes antigos n√£o tiverem peso ou ID, consertar agora.
                        let needsRepair = false;
                        safeInventory = safeInventory.map(f => {
                            if (!f.weight || !f.id) {
                                needsRepair = true;
                                return {
                                    ...f,
                                    weight: f.weight || Math.floor(Math.random() * 20) + 1,
                                    id: f.id || crypto.randomUUID(),
                                    name: f.name || 'Legacy Fish',
                                    emoji: f.emoji || 'üêü'
                                };
                            }
                            return f;
                        });

                        if (needsRepair) {
                            console.log("üõ†Ô∏è Invent√°rio reparado! Salvando corre√ß√µes...");
                            updateDoc(doc(db, 'users', user.uid), { inventory: safeInventory });
                        }
                        
                        userData = { ...d, inventory: safeInventory };
                        updateUI();
                        if (activeTab === 'inventory') renderInventory();
                    } else {
                        setDoc(doc(db, 'users', user.uid), { username: user.displayName, balance: 100, inventory: [] });
                    }
                });

                onSnapshot(query(collection(db, 'market'), orderBy('createdAt', 'desc')), (s) => {
                    renderMarket(s.docs.map(d => ({...d.data(), marketDocId: d.id})));
                });

                startIncomeLoop();
            } else {
                currentUser = null;
                accumulatedIncome = 0;
                login.style.display = 'flex';
                ui.classList.add('hidden');
                document.getElementById('btn-auth-submit').disabled = false;
                document.getElementById('btn-auth-submit').textContent = 'Conectar';
            }
        });

        // --- GAME LOGIC ---

        function startIncomeLoop() {
            if (window.incomeInt) clearInterval(window.incomeInt);
            if (window.syncInt) clearInterval(window.syncInt);

            window.incomeInt = setInterval(() => {
                if (!userData.inventory.length) {
                    document.getElementById('user-income').textContent = "0.00";
                    return;
                }
                
                let currentRate = 0;
                userData.inventory.forEach(fish => {
                    const inc = getCurrentIncome(fish);
                    if (!isNaN(inc)) currentRate += inc;
                });
                
                document.getElementById('user-income').textContent = currentRate.toFixed(2);
                
                if (currentRate > 0) {
                    accumulatedIncome += currentRate;
                    updateUI();
                }
            }, 1000);

            // Sync
            window.syncInt = setInterval(async () => {
                if (accumulatedIncome > 1 && currentUser) {
                    const val = accumulatedIncome;
                    accumulatedIncome = 0;
                    try {
                        await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(val) });
                    } catch(e) { accumulatedIncome += val; }
                }
            }, 30000);
        }

        function updateUI() {
            const total = (userData.balance || 0) + accumulatedIncome;
            const balEl = document.getElementById('user-balance');
            if (balEl) balEl.textContent = Math.floor(total).toLocaleString('pt-BR');
            
            const invEl = document.getElementById('inventory-count');
            if (invEl) invEl.textContent = userData.inventory.length;
        }

        function showMoneyPopup(txt) {
            const d = document.createElement('div');
            d.className = 'money-popup';
            d.textContent = `+$${txt}`;
            d.style.left = (20 + Math.random() * 60) + '%';
            d.style.top = (20 + Math.random() * 40) + '%';
            const container = document.getElementById('income-popups');
            if (container) {
                container.appendChild(d);
                setTimeout(() => d.remove(), 1500);
            }
        }

        // --- FISHING ---
        window.startFishing = async () => {
            const cost = Math.floor(BASE_BAIT_COST * marketState.inflation);
            const totalMoney = (userData.balance || 0) + accumulatedIncome;

            if (totalMoney < cost) {
                return showModal('Aviso', `<p class="text-center">Sem saldo para o Gas Fee de <span class="text-red-400 font-bold">$${cost}</span>.</p>`);
            }

            document.getElementById('fishing-idle').classList.add('hidden');
            document.getElementById('fishing-loading').classList.remove('hidden');

            try {
                if (accumulatedIncome > 0) {
                    await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(accumulatedIncome) });
                    accumulatedIncome = 0;
                }

                const newFish = generateFish();
                
                await runTransaction(db, async (t) => {
                    const ref = doc(db, 'users', currentUser.uid);
                    const docSnap = await t.get(ref);
                    const bal = docSnap.data().balance;
                    if (bal < cost) throw "Saldo insuficiente";
                    t.update(ref, {
                        balance: bal - cost,
                        inventory: arrayUnion(newFish)
                    });
                });

                setTimeout(() => {
                    document.getElementById('fishing-loading').classList.add('hidden');
                    const res = document.getElementById('fishing-result');
                    
                    document.getElementById('caught-emoji').textContent = newFish.emoji;
                    document.getElementById('caught-name').textContent = newFish.name;
                    document.getElementById('caught-hash').textContent = `Hash: ${newFish.id.substring(0,12)}...`;
                    document.getElementById('caught-weight').textContent = `${newFish.weight}kg`;
                    
                    const val = getCurrentFishValue(newFish);
                    document.getElementById('caught-val').textContent = `$${val}`;
                    
                    res.classList.remove('hidden');
                }, 1000);

            } catch (e) {
                document.getElementById('fishing-loading').classList.add('hidden');
                document.getElementById('fishing-idle').classList.remove('hidden');
                showModal('Erro', 'Falha na minera√ß√£o: ' + e);
            }
        };

        window.resetFishing = () => {
            document.getElementById('fishing-result').classList.add('hidden');
            document.getElementById('fishing-idle').classList.remove('hidden');
        };

        function generateFish() {
            const prefix = NAME_PARTS.PREFIX[Math.floor(Math.random() * NAME_PARTS.PREFIX.length)];
            const suffix = NAME_PARTS.SUFFIX[Math.floor(Math.random() * NAME_PARTS.SUFFIX.length)];
            const emoji = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
            
            let weight = Math.floor(Math.random() * 30) + 1;
            if (Math.random() > 0.8) weight += Math.floor(Math.random() * 50); 
            if (Math.random() > 0.95) weight += Math.floor(Math.random() * 200); 

            return {
                id: crypto.randomUUID(),
                name: `${prefix} ${suffix}`,
                emoji: emoji,
                weight: weight,
                mintedAt: Date.now()
            };
        }

        // --- INVENTORY ---
        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            if (!grid) return;

            if (!userData.inventory.length) {
                grid.innerHTML = '';
                document.getElementById('inventory-empty').classList.remove('hidden');
                return;
            }
            document.getElementById('inventory-empty').classList.add('hidden');

            // Ordena pelo peso (mais raros em cima)
            const sorted = [...userData.inventory].sort((a,b) => (b.weight || 0) - (a.weight || 0));

            grid.innerHTML = sorted.map(fish => {
                // Safety check
                if (!fish.id || !fish.name) return ''; 
                
                window.itemsCache[fish.id] = fish;
                
                const currentVal = getCurrentFishValue(fish);
                const currentIncome = getCurrentIncome(fish);
                const isHyped = fish.name.includes(marketState.hypeTag);
                const weightClass = fish.weight > 100 ? 'border-yellow-500/50' : (fish.weight > 50 ? 'border-purple-500/50' : 'border-slate-800');

                return `
                <div class="bg-slate-900 border ${isHyped ? 'border-purple-500 shadow-lg shadow-purple-900/20' : weightClass} p-3 rounded-xl flex items-center gap-3 relative overflow-hidden group hover:bg-slate-800/80 transition-colors">
                    ${isHyped ? '<div class="absolute top-0 right-0 bg-purple-600 text-[8px] px-2 py-0.5 text-white font-bold tracking-widest">TRENDING</div>' : ''}
                    <div class="text-4xl filter drop-shadow-md group-hover:scale-110 transition-transform">${fish.emoji}</div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-sm text-slate-200 truncate flex items-center gap-1">
                            ${fish.name} 
                            ${fish.weight > 100 ? 'üëë' : ''}
                        </div>
                        <div class="text-[9px] font-mono text-slate-500 flex gap-2">
                            <span>Hash: ${fish.id.slice(0,6)}...</span>
                            <span class="text-slate-400 font-bold">‚Ä¢ ${fish.weight}kg</span>
                        </div>
                        <div class="flex gap-2 mt-1.5">
                            <span class="text-[9px] bg-slate-950 px-2 py-0.5 rounded text-yellow-400 border border-slate-800 font-mono">APY +$${currentIncome}/s</span>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1 w-24">
                        <button onclick="window.askSell('${fish.id}')" class="bg-green-900/10 hover:bg-green-900/30 border border-green-900/30 text-green-400 text-xs py-1.5 rounded transition-all font-mono font-bold">
                            Vender $${currentVal}
                        </button>
                        <button onclick="window.askList('${fish.id}')" class="bg-blue-900/10 hover:bg-blue-900/30 border border-blue-900/30 text-blue-400 text-[10px] py-1.5 rounded transition-all">
                            P2P
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        window.askSell = (id) => {
            const fish = window.itemsCache[id];
            if(!fish) return;
            
            const livePrice = getCurrentFishValue(fish);
            
            showModal('Smart Contract', `
                <div class="text-center">
                    <div class="text-5xl mb-2 animate-bounce-slow">${fish.emoji}</div>
                    <div class="font-bold mb-1 text-white">${fish.name}</div>
                    <div class="text-xs text-slate-500 font-mono mb-6">${fish.id}</div>
                    
                    <div class="bg-green-900/20 p-4 rounded-xl border border-green-900/50 mb-4">
                        <div class="text-xs text-green-300 mb-1 uppercase tracking-widest">Valor de Liquidez</div>
                        <div class="text-4xl font-mono text-green-400 font-bold">$${livePrice}</div>
                    </div>
                    
                    <div class="text-[10px] text-slate-500">Taxa de Rede: 0% ‚Ä¢ Execu√ß√£o Instant√¢nea</div>
                </div>
                <button id="modal-confirm-action" class="w-full mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-green-900/20 transition-all active:scale-95">
                    CONFIRMAR VENDA
                </button>
            `);

            document.getElementById('modal-confirm-action').onclick = async () => {
                closeModal();
                try {
                    const finalPrice = getCurrentFishValue(fish); 
                    
                    if (accumulatedIncome > 0) {
                        await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(accumulatedIncome) });
                        accumulatedIncome = 0;
                    }

                    await runTransaction(db, async(t) => {
                        const ref = doc(db, 'users', currentUser.uid);
                        const s = await t.get(ref);
                        const inv = s.data().inventory;
                        const newInv = inv.filter(i => i.id !== fish.id);
                        if(inv.length === newInv.length) throw "Item n√£o encontrado";
                        t.update(ref, { inventory: newInv, balance: increment(finalPrice) });
                    });
                } catch(e) { console.error(e); }
            };
        };

        window.askList = (id) => {
            const fish = window.itemsCache[id];
            if (!fish) return;
            const suggested = getCurrentFishValue(fish) * 2;

            showModal('Exchange Order', `
                <div class="mb-4">
                    <div class="flex items-center gap-3 mb-4 bg-slate-950 p-3 rounded-lg border border-slate-800">
                        <div class="text-2xl">${fish.emoji}</div>
                        <div>
                            <div class="text-sm font-bold text-white">${fish.name}</div>
                            <div class="text-xs text-slate-500">${fish.weight}kg</div>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 mb-1 font-bold">Pre√ßo de Venda ($)</div>
                    <input type="number" id="p2p-price" class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-white font-mono text-lg focus:border-blue-500 outline-none" value="${suggested}">
                    <p class="text-[10px] text-slate-500 mt-2">Sugest√£o de mercado: $${suggested}</p>
                </div>
                <button id="modal-confirm-action" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition-all">CRIAR ORDEM</button>
            `);

            document.getElementById('modal-confirm-action').onclick = async () => {
                const price = parseInt(document.getElementById('p2p-price').value);
                if(!price || price <= 0) return;
                closeModal();

                await runTransaction(db, async(t) => {
                    const ref = doc(db, 'users', currentUser.uid);
                    const s = await t.get(ref);
                    const inv = s.data().inventory.filter(i => i.id !== fish.id);
                    t.update(ref, { inventory: inv });
                });
                
                await addDoc(collection(db, 'market'), {
                    ...fish, price, sellerId: currentUser.uid, sellerName: currentUser.displayName, createdAt: serverTimestamp()
                });
            };
        };

        function renderMarket(items) {
            const grid = document.getElementById('market-grid');
            if (!grid) return;

            if(!items.length) {
                grid.innerHTML = '';
                document.getElementById('market-empty').classList.remove('hidden');
                return;
            }
            document.getElementById('market-empty').classList.add('hidden');

            grid.innerHTML = items.map(item => {
                // Ignore bad items
                if (!item.id || !item.name) return '';

                window.itemsCache[item.id] = item; 
                window.itemsCache['doc_'+item.id] = item.marketDocId; 

                const isMine = item.sellerId === currentUser.uid;
                
                return `
                <div class="bg-slate-900 border border-slate-800 p-3 rounded-xl flex flex-col gap-2 relative">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${item.emoji}</div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-sm text-slate-200">${item.name}</div>
                            <div class="text-[10px] text-slate-500 flex justify-between">
                                <span>${item.sellerName}</span>
                                <span>${item.weight || '?'}kg</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-black/30 p-2 rounded flex justify-between items-center border border-slate-800/50">
                        <span class="text-[10px] text-slate-400">ASK PRICE</span>
                        <span class="text-green-400 font-mono font-bold">$${item.price}</span>
                    </div>
                    <button onclick="window.buyFish('${item.id}', '${item.marketDocId}')" class="w-full py-2 rounded text-xs font-bold transition-all ${isMine ? 'bg-slate-800 text-slate-400 border border-slate-700 hover:bg-slate-700' : 'bg-green-600 text-white hover:bg-green-500 shadow-lg shadow-green-900/20'}">
                        ${isMine ? 'CANCELAR ORDEM' : 'COMPRAR ATIVO'}
                    </button>
                </div>
                `;
            }).join('');
        }

        window.buyFish = async (fishId, docId) => {
            const fish = window.itemsCache[fishId];
            if(!fish) return;

            const total = (userData.balance || 0) + accumulatedIncome;
            const isMine = fish.sellerId === currentUser.uid;

            if (!isMine && total < fish.price) return showModal('Erro', 'Saldo Insuficiente na Carteira');

            try {
                if (accumulatedIncome > 0) {
                    await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(accumulatedIncome) });
                    accumulatedIncome = 0;
                }

                await runTransaction(db, async(t) => {
                    const marketRef = doc(db, 'market', docId);
                    const mSnap = await t.get(marketRef);
                    if(!mSnap.exists()) throw "Ordem expirada ou j√° preenchida";

                    const buyerRef = doc(db, 'users', currentUser.uid);
                    
                    if (isMine) {
                        t.delete(marketRef);
                        const {price, sellerId, sellerName, createdAt, marketDocId, ...fishData} = fish;
                        t.update(buyerRef, { inventory: arrayUnion(fishData) });
                    } else {
                        const sellerRef = doc(db, 'users', fish.sellerId);
                        const bSnap = await t.get(buyerRef);
                        if(bSnap.data().balance < fish.price) throw "Sem saldo para execu√ß√£o";

                        t.delete(marketRef);
                        const {price, sellerId, sellerName, createdAt, marketDocId, ...fishData} = fish;
                        
                        t.update(buyerRef, { 
                            balance: increment(-price),
                            inventory: arrayUnion(fishData)
                        });
                        t.update(sellerRef, { balance: increment(price) });
                    }
                });
            } catch(e) { showModal('Erro Transa√ß√£o', e); }
        };

        // --- RANKING ---
        async function loadRanking() {
            const list = document.getElementById('ranking-list');
            if(!list) return;
            list.innerHTML = '<div class="loader mx-auto"></div>';
            
            try {
                const q = query(collection(db, 'users'), orderBy('balance', 'desc'), limit(10));
                const s = await getDocs(q);
                let html = '';
                s.forEach((d, i) => {
                    const u = d.data();
                    const rank = i+1;
                    const trophy = rank === 1 ? 'ü•á' : (rank === 2 ? 'ü•à' : (rank === 3 ? 'ü•â' : `<span class="text-slate-500 font-mono text-sm">#${rank}</span>`));
                    const bgClass = rank === 1 ? 'bg-gradient-to-r from-yellow-900/20 to-transparent border-yellow-700/30' : 'bg-slate-900 border-slate-800';
                    
                    html += `
                        <div class="flex items-center gap-3 p-3 rounded-lg border ${bgClass} transition-all hover:scale-[1.01]">
                            <div class="w-8 text-center text-lg">${trophy}</div>
                            <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center font-bold text-xs border border-slate-700">
                                ${(u.username||'U')[0].toUpperCase()}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-sm text-slate-200 truncate">${u.username}</div>
                            </div>
                            <div class="font-mono text-green-400 font-bold text-sm">$${Math.floor(u.balance).toLocaleString()}</div>
                        </div>
                    `;
                });
                list.innerHTML = html || '<div class="text-center py-4 text-slate-500">Sem dados de mercado</div>';
            } catch(e) { list.innerHTML = '<div class="text-center py-4 text-red-400 text-xs">Erro ao carregar livro de ordens</div>'; }
        }

        // --- UI UTILS ---
        window.switchTab = (t) => {
            activeTab = t;
            ['fishing', 'inventory', 'market', 'ranking'].forEach(x => {
                const btn = document.getElementById(`tab-${x}`);
                const view = document.getElementById(`view-${x}`);
                if(x === t) {
                    btn.classList.add('bg-blue-600', 'text-white', 'scale-105', 'border-blue-500');
                    btn.classList.remove('bg-slate-800', 'text-slate-400', 'border-transparent');
                    view.classList.remove('hidden');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'scale-105', 'border-blue-500');
                    btn.classList.add('bg-slate-800', 'text-slate-400', 'border-transparent');
                    view.classList.add('hidden');
                }
            });
            if(t === 'ranking') loadRanking();
            if(t === 'inventory') renderInventory();
        };

        window.showModal = (title, content) => {
            const ol = document.getElementById('modal-overlay');
            const ct = document.getElementById('modal-content');
            ct.innerHTML = `
                <div class="p-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="info" class="w-5 h-5 text-blue-400"></i> ${title}
                    </h3>
                    <div class="text-slate-300 text-sm leading-relaxed">${content}</div>
                    <button onclick="window.closeModal()" class="mt-6 w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-lg text-slate-300 text-xs font-bold uppercase tracking-wider transition-colors">Fechar Janela</button>
                </div>
            `;
            lucide.createIcons();
            ol.classList.remove('hidden');
            setTimeout(() => { ol.classList.remove('opacity-0'); ct.classList.remove('scale-95'); }, 10);
        };

        window.closeModal = () => {
            const ol = document.getElementById('modal-overlay');
            const ct = document.getElementById('modal-content');
            ol.classList.add('opacity-0'); ct.classList.add('scale-95');
            setTimeout(() => ol.classList.add('hidden'), 300);
        };

        lucide.createIcons();
    </script>
</body>
</html>
